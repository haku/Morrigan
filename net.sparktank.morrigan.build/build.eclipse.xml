<project name="net.sparktank.morrigan.build" default="main">

	<target name="setup">
		<!-- Main props file. -->
		<property file="build.properties" />

		<!-- Configure build process. -->
		<property name="outputDirectory" value="${basedir}/builds" />

		<!-- Locate deltapack. -->
		<property name="deltapack" value="${eclipse.home}/../eclipse-3.5.2-delta-pack" />
		<echo message="deltapack=${deltapack}" />
		<available property="haveDeltaPack" file="${deltapack}" />
		<fail unless="haveDeltaPack" message="Deltapack not found." />

		<!-- Configure RCP build process. -->
		<property name="baseLocation" value="${eclipse.home}" />
		<property name="builder" value="${basedir}" />
		<property name="buildDirectory" value="${basedir}/buildDirectory" />
		<property name="pluginPath" value="${basedir}/..${path.separator}${deltapack}" />
		<property name="buildTempFolder" value="${buildDirectory}" />

		<echo message="baseLocation=${baseLocation}" />
		<echo message="builder=${builder}" />
		<echo message="buildDirectory=${buildDirectory}" />
		<echo message="pluginPath=${pluginPath}" />
		<echo message="buildTempFolder=${buildTempFolder}" />
	</target>

	<target name="main" depends="setup,clean">
		<!-- Call RCP build process. -->
		<ant antfile="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />

		<!-- Move output. -->
		<mkdir dir="${outputDirectory}" />
		<move todir="${outputDirectory}">
			<fileset dir="${buildDirectory}/${buildLabel}" includes="*.zip" />
		</move>

		<!-- build engines. -->
		<antcall target="eng_win32" />
		<antcall target="eng_linux" />

		<antcall target="refreshWorkspace" />
	</target>

	<target name="eng_win32" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.dsj/makejar.xml" dir="../net.sparktank.morrigan.playbackimpl.dsj" />
		<ant antfile="../net.sparktank.morrigan.hotkeyimpl.jintellitype/makejar.xml" dir="../net.sparktank.morrigan.hotkeyimpl.jintellitype" />

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*win32*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.dsj" includes="*.jar" prefix="morrigan/engines" />
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jintellitype" includes="*.jar" prefix="morrigan/engines" />
			<!-- TODO Include properties file. -->
		</zip>
	</target>

	<target name="eng_linux" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.gs/makejar.xml" dir="../net.sparktank.morrigan.playbackimpl.gs" />
		<ant antfile="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey/makejar.xml" dir="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey" />

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*linux*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.gs" includes="*.jar" prefix="morrigan/engines" />
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey" includes="*.jar" prefix="morrigan/engines" />
			<!-- TODO Include properties file. -->
		</zip>
	</target>

	<target name="eng_mac" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.jmf/makejar.xml" dir="../net.sparktank.morrigan.playbackimpl.jmf" />

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*macosx*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.jmf" includes="*.jar" prefix="morrigan/engines" />
			<!-- TODO Include properties file. -->
		</zip>
	</target>

	<target name="clean" depends="setup">
		<delete dir="${buildDirectory}" failonerror="false" />
		<delete dir="${outputDirectory}" failonerror="false" />

		<antcall target="refreshWorkspace" />
	</target>

	<target name="refreshWorkspace">
		<!-- Refresh eclipse workspace -->
		<eclipse.convertPath fileSystemPath="${basedir}" property="resourcePath" />
		<eclipse.refreshLocal resource="${resourcePath}" depth="infinite" />
	</target>

</project>
