<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== 
      
     ====================================================================== -->

<project name="net.sparktank.morrigan.build" default="main">

	<target name="setup">
		<!-- Main props file. -->
		<property file="build.properties" />

		<!-- Generated properties. -->
		<tstamp>
			<format property="timestamp" pattern="yyyyMMdd_HHmm" timezone="UTC" />
		</tstamp>
		<property name="buildId" value="${archivePrefix}-${releaseName}-${timestamp}" />
		<property name="buildLabel" value="${buildType}.${buildId}" />

		<!-- Configure build process. -->
		<property name="outputDirectory" value="${basedir}/builds" />

		<!-- Locate deltapack. -->
		<property name="deltapack" value="${eclipse.home}/../eclipse-3.5.2-delta-pack" />
		<echo message="deltapack=${deltapack}" />
		<available property="haveDeltaPack" file="${deltapack}" />
		<fail unless="haveDeltaPack" message="Deltapack not found." />

		<!-- Configure RCP build process. -->
		<property name="baseLocation" value="${eclipse.home}" />
		<property name="builder" value="${basedir}" />
		<property name="buildDirectory" value="${basedir}/buildDirectory" />
		<property name="pluginPath" value="${basedir}/..${path.separator}${deltapack}" />
		<property name="buildTempFolder" value="${buildDirectory}" />

		<echo message="baseLocation=${baseLocation}" />
		<echo message="builder=${builder}" />
		<echo message="buildDirectory=${buildDirectory}" />
		<echo message="pluginPath=${pluginPath}" />
		<echo message="buildTempFolder=${buildTempFolder}" />
	</target>

	<target name="clean" depends="setup">
		<delete dir="${buildDirectory}" failonerror="false" />
		<delete dir="${outputDirectory}" failonerror="false" />

		<antcall target="refreshWorkspace" />
	</target>

	<target name="refreshWorkspace">
		<!-- Refresh eclipse workspace -->
		<eclipse.convertPath fileSystemPath="${basedir}" property="resourcePath" />
		<eclipse.refreshLocal resource="${resourcePath}" depth="infinite" />
	</target>

	<target name="main" depends="setup,clean">
		<!-- Call RCP build process. -->
		<ant antfile="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />

		<!-- Move output. -->
		<mkdir dir="${outputDirectory}" />
		<move todir="${outputDirectory}">
			<fileset dir="${buildDirectory}/${buildLabel}" includes="*.zip" />
		</move>

		<!-- Build server jar. -->
		<antcall target="buildbits" />

		<!-- Build outputs. -->
		<antcall target="zip_win32" />
		<antcall target="zip_linux" />
		<antcall target="zip_mac" />

		<!-- Clean up. -->
		<antcall target="refreshWorkspace" />
	</target>

	<target name="buildbits" depends="setup">
		<ant antfile="../net.sparktank.morrigan.wui/build.xml"
		     dir="../net.sparktank.morrigan.wui"
		/>
		<ant antfile="../net.sparktank.morrigan/build_serverjar.xml"
		     dir="../net.sparktank.morrigan"
		/>
	</target>

	<target name="zip_win32" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.dsj/makejar.xml"
		     dir="../net.sparktank.morrigan.playbackimpl.dsj"
		/>
		<ant antfile="../net.sparktank.morrigan.hotkeyimpl.jintellitype/makejar.xml"
		     dir="../net.sparktank.morrigan.hotkeyimpl.jintellitype"
		/>

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*win32*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.dsj"
			            includes="*.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.dsj/lib"
			            includes="*"
			            excludes="swt.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jintellitype"
			            includes="*.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jintellitype/lib"
			            includes="*"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="propfiles"
			            includes="win32.properties"
			            fullpath="morrigan/morrigan.properties"
			/>
			<zipfileset dir="../net.sparktank.morrigan"
			            includes="morrigan.server.jar"
			            fullpath="morrigan/morrigan.server.jar"
			/>
			<zipfileset dir="../net.sparktank.morrigan/lib" prefix="morrigan/lib" />
			<zipfileset dir="../net.sparktank.morrigan.wui" includes="morrigan.wui.war" prefix="morrigan/" />
		</zip>
	</target>

	<target name="zip_linux" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.gs/makejar.xml"
		     dir="../net.sparktank.morrigan.playbackimpl.gs"
		/>
		<ant antfile="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey/makejar.xml"
		     dir="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey"
		/>

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*linux*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.gs"
			            includes="*.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.gs/lib"
			            includes="*"
			            excludes="swt.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey"
			            includes="*.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.hotkeyimpl.jxgrabkey/lib"
			            includes="*"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="propfiles"
			            includes="linux.properties"
			            fullpath="morrigan/morrigan.properties"
			/>
			<zipfileset dir="../net.sparktank.morrigan"
			            includes="morrigan.server.jar"
			            fullpath="morrigan/morrigan.server.jar"
			/>
			<zipfileset dir="../net.sparktank.morrigan/lib" prefix="morrigan/lib" />
			<zipfileset dir="../net.sparktank.morrigan.wui" includes="morrigan.wui.war" prefix="morrigan/" />
		</zip>
	</target>

	<target name="zip_mac" depends="setup">
		<ant antfile="../net.sparktank.morrigan.playbackimpl.jmf/makejar.xml"
		     dir="../net.sparktank.morrigan.playbackimpl.jmf"
		/>

		<fileset dir="${outputDirectory}" id="zipfiles">
			<include name="*macosx*.zip" />
		</fileset>
		<pathconvert pathsep="" property="zipfile" refid="zipfiles" />
		<echo message="zipfile=${zipfile}" />

		<zip destfile="${zipfile}" update="true" whenempty="fail">
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.jmf"
			            includes="*.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="../net.sparktank.morrigan.playbackimpl.jmf/lib"
			            includes="*"
			            excludes="swt.jar"
			            prefix="morrigan/engines"
			/>
			<zipfileset dir="propfiles"
			            includes="mac.properties"
			            fullpath="morrigan/morrigan.properties"
			/>
			<zipfileset dir="../net.sparktank.morrigan"
			            includes="morrigan.server.jar"
			            fullpath="morrigan/morrigan.server.jar"
			/>
			<zipfileset dir="../net.sparktank.morrigan/lib" prefix="morrigan/lib" />
			<zipfileset dir="../net.sparktank.morrigan.wui" includes="morrigan.wui.war" prefix="morrigan/" />
		</zip>
	</target>

</project>
